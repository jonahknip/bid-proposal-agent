<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bid Proposal Agent - Abonmarche</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='46' fill='none' stroke='%231B365D' stroke-width='4'/><text x='50' y='65' font-size='40' font-weight='bold' fill='%23C8102E' text-anchor='middle'>$</text></svg>">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #E3F2FD;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        .logo { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px; }
        .logo-icon { width: 50px; height: 50px; }
        h1 { color: #1A1A1A; font-size: 2rem; font-weight: 700; }
        h1 span { color: #C8102E; }
        .subtitle { color: #666; font-size: 1rem; }
        .brand { color: #C8102E; font-weight: 600; font-size: 0.85rem; letter-spacing: 1px; margin-top: 5px; }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 20px;
            border-top: 4px solid #C8102E;
        }
        .card h2 {
            color: #1B365D;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        .card-description { color: #666; font-size: 0.9rem; margin-bottom: 15px; line-height: 1.5; }

        .file-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #F8F9FA;
        }
        .file-upload:hover { border-color: #C8102E; background: #FFF5F5; }
        .file-upload.dragover { border-color: #C8102E; background: #FFF0F0; }
        .file-upload.has-files { border-color: #28a745; background: #F0FFF0; }
        .file-upload input { display: none; }
        .file-upload .upload-icon { font-size: 3rem; color: #999; margin-bottom: 10px; }
        .file-upload .upload-text { color: #666; font-size: 1rem; }
        .file-upload .file-types { color: #999; font-size: 0.8rem; margin-top: 8px; }

        .file-list { margin-top: 15px; font-size: 0.9rem; }
        .file-item {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 12px; background: #F5F5F5;
            border-radius: 4px; margin-bottom: 5px;
        }

        .btn {
            display: inline-block; padding: 14px 28px;
            background: #C8102E; color: white; border: none;
            border-radius: 6px; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: background 0.2s; text-align: center;
        }
        .btn:hover:not(:disabled) { background: #A00D25; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-block { width: 100%; margin-top: 20px; }
        .btn-secondary { background: #1B365D; }
        .btn-secondary:hover:not(:disabled) { background: #132744; }
        .btn-outline { background: transparent; border: 2px solid #C8102E; color: #C8102E; }
        .btn-outline:hover:not(:disabled) { background: #C8102E; color: white; }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }

        .spinner {
            display: inline-block; width: 18px; height: 18px;
            border: 3px solid white; border-top-color: transparent;
            border-radius: 50%; animation: spin 1s linear infinite;
            margin-right: 10px; vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .info-box {
            background: #E3F2FD; border-left: 4px solid #1B365D;
            padding: 15px; margin-bottom: 20px; border-radius: 0 6px 6px 0;
            font-size: 0.9rem; color: #1B365D;
        }

        .report-content {
            background: #FAFAFA; border: 1px solid #ddd;
            border-radius: 8px; padding: 20px;
            max-height: 700px; overflow-y: auto;
        }

        .analysis-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }

        .score-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        @media (max-width: 600px) { .score-grid { grid-template-columns: 1fr; } }
        .score-box {
            text-align: center; padding: 20px; border-radius: 8px; background: #F8F9FA;
        }
        .score-box .number { font-size: 2rem; font-weight: 700; }
        .score-box .label { font-size: 0.8rem; color: #666; margin-top: 5px; }

        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #ddd; }
        .tab {
            padding: 10px 20px; background: transparent; border: none;
            cursor: pointer; font-size: 0.9rem; color: #666;
            border-bottom: 2px solid transparent; margin-bottom: -2px;
        }
        .tab:hover { color: #1B365D; }
        .tab.active { color: #1B365D; border-bottom-color: #C8102E; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .rec-list { list-style: none; padding: 0; }
        .rec-list li {
            padding: 12px 15px; margin-bottom: 8px; border-radius: 6px;
            display: flex; align-items: flex-start; gap: 10px;
        }
        .rec-list li.critical { background: #F8D7DA; border-left: 4px solid #DC3545; }
        .rec-list li.high { background: #FFF3CD; border-left: 4px solid #FFC107; }
        .rec-list li.medium { background: #E3F2FD; border-left: 4px solid #1B365D; }

        .progress-status {
            padding: 15px; background: #FFF3CD; border-radius: 8px;
            margin-bottom: 20px; text-align: center; font-size: 0.95rem;
        }
        .progress-status.error { background: #F8D7DA; color: #721c24; }

        footer {
            text-align: center; color: #999; font-size: 0.85rem;
            margin-top: 30px; padding: 20px;
        }
        footer a { color: #C8102E; text-decoration: none; }

        #resultsSection { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <svg class="logo-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="46" fill="none" stroke="#1B365D" stroke-width="4"/>
                    <text x="50" y="68" font-size="45" font-weight="bold" fill="#C8102E" text-anchor="middle">$</text>
                </svg>
                <h1>Bid <span>Proposal</span> Agent</h1>
            </div>
            <p class="subtitle">Expert Civil Engineering Bid Analysis</p>
            <p class="brand">ABONMARCHE</p>
        </header>

        <div class="info-box">
            <strong>Upload bid documents (RFP, bid schedule, specs) and get an expert analysis with material, labor, and equipment cost breakdowns.</strong>
        </div>

        <!-- Upload Section -->
        <div class="card" id="uploadSection">
            <h2>Upload Bid Documents</h2>
            <p class="card-description">
                Upload the RFP, bid schedule, specifications, or any bid documents. 
                AI will analyze everything and provide expert cost estimates with recommendations.
            </p>

            <div class="file-upload" id="fileUpload">
                <input type="file" id="fileInput" multiple accept=".pdf,.xlsx,.xls,.xlsm">
                <div class="upload-icon">&#128196;</div>
                <div class="upload-text">Click to select or drag & drop bid documents</div>
                <div class="file-types">PDF, Excel (.xlsx, .xls)</div>
            </div>
            
            <div class="file-list" id="fileList"></div>
            
            <button class="btn btn-block" id="analyzeBtn" disabled>
                Analyze Bid Documents
            </button>
        </div>

        <!-- Progress -->
        <div class="progress-status" id="progressStatus" style="display: none;">
            <span class="spinner"></span>
            <span id="progressText">Processing...</span>
        </div>

        <!-- Results Section -->
        <div class="card" id="resultsSection">
            <div class="analysis-header">
                <h2 style="margin: 0;">Analysis Results</h2>
                <div class="btn-group">
                    <button class="btn btn-sm" id="exportWordBtn">Export Word</button>
                    <button class="btn btn-sm btn-secondary" id="exportExcelBtn">Export Excel</button>
                    <button class="btn btn-sm btn-outline" id="newAnalysisBtn">New Analysis</button>
                </div>
            </div>

            <div id="statusBanner"></div>

            <div class="score-grid" id="scoreGrid"></div>

            <div class="tabs">
                <button class="tab active" data-tab="summary">Summary</button>
                <button class="tab" data-tab="items">Line Items</button>
                <button class="tab" data-tab="recommendations">Recommendations</button>
            </div>

            <div class="tab-content active" id="tab-summary">
                <div class="report-content" id="reportContent"></div>
            </div>

            <div class="tab-content" id="tab-items">
                <div class="report-content" id="itemsContent">
                    <p style="color: #666;">Line items will appear here.</p>
                </div>
            </div>

            <div class="tab-content" id="tab-recommendations">
                <ul class="rec-list" id="recList"></ul>
            </div>
        </div>

        <footer>
            <p>Bid Proposal Agent - Expert Civil Engineering Bid Analysis</p>
            <p>Questions? Contact <a href="mailto:jknip@abonmarche.com">Jonah Knip</a></p>
        </footer>
    </div>

    <script>
        const fileUpload = document.getElementById('fileUpload');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const progressStatus = document.getElementById('progressStatus');
        const progressText = document.getElementById('progressText');
        const uploadSection = document.getElementById('uploadSection');
        const resultsSection = document.getElementById('resultsSection');

        // File upload handling
        fileUpload.addEventListener('click', () => fileInput.click());
        fileUpload.addEventListener('dragover', (e) => { e.preventDefault(); fileUpload.classList.add('dragover'); });
        fileUpload.addEventListener('dragleave', () => fileUpload.classList.remove('dragover'));
        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            fileInput.files = e.dataTransfer.files;
            updateFileList();
        });
        fileInput.addEventListener('change', updateFileList);

        function updateFileList() {
            fileList.innerHTML = '';
            if (fileInput.files.length > 0) {
                fileUpload.classList.add('has-files');
                analyzeBtn.disabled = false;
                Array.from(fileInput.files).forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.innerHTML = `<span>&#128196;</span><span>${file.name}</span><span style="color:#999;font-size:0.8rem;">(${(file.size/1024/1024).toFixed(1)} MB)</span>`;
                    fileList.appendChild(div);
                });
            } else {
                fileUpload.classList.remove('has-files');
                analyzeBtn.disabled = true;
            }
        }

        function showProgress(msg) {
            progressStatus.style.display = 'block';
            progressStatus.className = 'progress-status';
            progressText.textContent = msg;
        }

        function showError(msg) {
            progressStatus.style.display = 'block';
            progressStatus.className = 'progress-status error';
            progressStatus.innerHTML = msg;
        }

        function hideProgress() {
            progressStatus.style.display = 'none';
        }

        // Main analyze function - single click does everything
        analyzeBtn.addEventListener('click', async () => {
            const formData = new FormData();
            Array.from(fileInput.files).forEach(file => formData.append('files', file));

            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<span class="spinner"></span>Analyzing...';
            showProgress('Uploading and parsing documents...');

            try {
                // Step 1: Upload and parse
                showProgress('Extracting information from documents...');
                const parseResponse = await fetch('/api/parse-bid-docs', { method: 'POST', body: formData });
                const parseData = await parseResponse.json();

                if (!parseData.success) {
                    throw new Error(parseData.error || 'Failed to parse documents');
                }

                // Step 2: Analyze
                showProgress('Generating expert analysis and cost estimates...');
                const analyzeResponse = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const analysisData = await analyzeResponse.json();

                if (!analysisData.success) {
                    throw new Error(analysisData.error || 'Analysis failed');
                }

                hideProgress();
                displayResults(analysisData);

            } catch (err) {
                showError(`Error: ${err.message}`);
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze Bid Documents';
            }
        });

        function displayResults(data) {
            uploadSection.style.display = 'none';
            resultsSection.style.display = 'block';
            
            const status = data.status || {};
            const statusColor = status.color === 'green' ? '#28a745' : status.color === 'red' ? '#dc3545' : '#ffc107';
            
            document.getElementById('statusBanner').innerHTML = `
                <div style="background: ${statusColor}20; border-left: 4px solid ${statusColor}; padding: 15px; margin-bottom: 20px; border-radius: 0 6px 6px 0;">
                    <strong style="color: ${statusColor}; font-size: 1.1rem;">${status.status || 'ANALYSIS COMPLETE'}</strong>
                    <p style="margin: 5px 0 0 0;">${status.message || ''}</p>
                </div>
            `;

            const overall = data.overall_assessment || {};
            const pricing = data.pricing_analysis || {};
            const estimate = data.estimate || {};
            const summary = estimate.summary || {};
            const totalBid = summary.total_bid || pricing.total_bid || 0;
            
            document.getElementById('scoreGrid').innerHTML = `
                <div class="score-box" style="background: #e3f2fd;">
                    <div class="number" style="color: #1B365D;">${overall.competitiveness_score || 'N/A'}/10</div>
                    <div class="label">Competitiveness</div>
                </div>
                <div class="score-box" style="background: #e8f5e9;">
                    <div class="number" style="color: #28a745;">${overall.confidence_score || 'N/A'}/10</div>
                    <div class="label">Confidence</div>
                </div>
                <div class="score-box" style="background: #fff3e0;">
                    <div class="number" style="color: #E67E22;">$${totalBid.toLocaleString()}</div>
                    <div class="label">Total Estimate</div>
                </div>
            `;

            // Summary report
            document.getElementById('reportContent').innerHTML = data.html_report || `
                <h3>Executive Summary</h3>
                <p>${overall.summary || 'Analysis complete.'}</p>
            `;

            // Line Items
            const bidItems = estimate.bid_items || [];
            if (bidItems.length > 0) {
                let itemsHtml = '<table style="width:100%; border-collapse: collapse; font-size: 0.85rem;">';
                itemsHtml += '<tr style="background: #1B365D; color: white;"><th style="padding: 10px; text-align: left;">Item</th><th style="padding: 10px; text-align: left;">Description</th><th style="padding: 10px; text-align: right;">Qty</th><th style="padding: 10px;">Unit</th><th style="padding: 10px; text-align: right;">Material</th><th style="padding: 10px; text-align: right;">Labor</th><th style="padding: 10px; text-align: right;">Equip</th><th style="padding: 10px; text-align: right;">Total</th></tr>';
                bidItems.forEach((item, i) => {
                    const bg = i % 2 === 0 ? '#f8f9fa' : '#ffffff';
                    const mat = item.material?.cost || item.material || 0;
                    const lab = item.labor?.cost || item.labor || 0;
                    const equip = item.equipment?.cost || item.equipment || 0;
                    itemsHtml += `<tr style="background: ${bg};">
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.item_number || ''}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">${(item.description || '').substring(0, 40)}${item.description?.length > 40 ? '...' : ''}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">${(item.quantity || 0).toLocaleString()}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;">${item.unit || ''}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">$${Number(mat).toLocaleString()}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">$${Number(lab).toLocaleString()}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">$${Number(equip).toLocaleString()}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right; font-weight: bold;">$${(item.total_price || 0).toLocaleString()}</td>
                    </tr>`;
                });
                // Summary row
                itemsHtml += `<tr style="background: #1B365D; color: white; font-weight: bold;">
                    <td colspan="7" style="padding: 12px; text-align: right;">TOTAL BID:</td>
                    <td style="padding: 12px; text-align: right;">$${totalBid.toLocaleString()}</td>
                </tr>`;
                itemsHtml += '</table>';
                document.getElementById('itemsContent').innerHTML = itemsHtml;
            } else {
                document.getElementById('itemsContent').innerHTML = '<p>No line items extracted.</p>';
            }

            // Recommendations
            const recList = document.getElementById('recList');
            recList.innerHTML = '';
            const recommendations = data.recommendations || [];
            if (recommendations.length > 0) {
                recommendations.forEach((rec, i) => {
                    const priority = rec.priority || 'MEDIUM';
                    const cls = priority === 'CRITICAL' ? 'critical' : priority === 'HIGH' ? 'high' : 'medium';
                    recList.innerHTML += `
                        <li class="${cls}">
                            <span style="font-weight: bold; min-width: 25px;">${i+1}.</span>
                            <div>
                                <strong>[${priority}]</strong> ${rec.action || ''}
                                ${rec.rationale ? `<br><small style="color: #666;">${rec.rationale}</small>` : ''}
                            </div>
                        </li>
                    `;
                });
            } else {
                recList.innerHTML = '<li class="medium">No specific recommendations at this time.</li>';
            }

            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        // Export Word
        document.getElementById('exportWordBtn').addEventListener('click', async () => {
            const btn = document.getElementById('exportWordBtn');
            btn.disabled = true;
            btn.textContent = 'Exporting...';
            try {
                const response = await fetch('/api/export/word', { method: 'POST' });
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Bid_Analysis.docx';
                    a.click();
                } else {
                    const data = await response.json();
                    alert(`Export failed: ${data.error}`);
                }
            } catch (err) {
                alert(`Error: ${err.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Export Word';
            }
        });

        // Export Excel
        document.getElementById('exportExcelBtn').addEventListener('click', async () => {
            const btn = document.getElementById('exportExcelBtn');
            btn.disabled = true;
            btn.textContent = 'Exporting...';
            try {
                const response = await fetch('/api/export/excel', { method: 'POST' });
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Bid_Estimate.xlsx';
                    a.click();
                } else {
                    const data = await response.json();
                    alert(`Export failed: ${data.error}`);
                }
            } catch (err) {
                alert(`Error: ${err.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Export Excel';
            }
        });

        // New Analysis
        document.getElementById('newAnalysisBtn').addEventListener('click', async () => {
            await fetch('/api/clear', { method: 'POST' });
            location.reload();
        });
    </script>
</body>
</html>
